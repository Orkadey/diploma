## Криминалистически правильные методы извлечения дампов оперативной памяти виртуальных машин в контексте платформы виртуализации QEMU/KVM

## Введение

### Актуальность

С расширением информатизации современного общества одновременно учащаются преступления в сфере информационных технологий. В связи с тем, что облачные вычисления, основанные на использовании платформ виртуализации, все чаще занимают центральное место в организации ИТ инфраструктур, у хакеров появляется большой стимул для получения доступа к виртуальной среде окружения. Таким образом растет необходимость в создании систем безопасности для противостояния киберпреступности.

Виртуализация обеспечивает уровень абстракции через эмуляцию аппаратного обеспечения и содействует распределению ресурсов между различными гостевыми машинами с различными операционными системами в форме виртуальных машин. Среда виртуализации состоит из нескольких виртуальных машин, монитора виртуальных машин, т. е. гипервизора и аппаратных средств, регулирующих доступ к ресурсам. Поскольку технологии виртуализации широко используются, лежащая в основе инфраструктура виртуализации становится потенциальной целью для атак [1].

Традиционные средства защиты операционных систем, такие как антивирусы, обеспечивают безопасность, используя перманентные агенты, установленные непосредственно внутри целевых систем. Главным недостатком такого подхода является уязвимость самих инструментов защиты перед вредоносным ПО, которое может, используя, скажем, нетривиальные комбинации эксплуатации неисправленных уязвимостей ядра и антиотладочные приемы, не только скрывать себя, но и блокировать программы-охранители.

Одним из решений, устраняющим недостатки является использование методов, имеющих в своей основе принципы компьютерной криминалистики - дисциплины о раскрытии и расследовании преступлений, связанных с компьютерной информацией, о методах получения и исследовании доказательств, имеющих форму компьютерной информации и о применяемых для этого технических средств [2]. Далее такие методы будем обобщать понятием «криминалистический подход». Ключевыми понятиями в определении компьютерной криминалистики являются получение и исследование доказательств, при этом необходимо придерживаться определенных требований, соответствующих целям данной дисплины:

* сохранение целостности и достоверности данных;
* предотвращение «загрязнения» данных;
* полная и правильная документация;
* реализация правильных научных методов.

### Классификации методов

Тематикой работы является извлечение компьютерной информации. Можно выделять множество классов методов, применяемых для получения данных. Классификация зависит от выбираемого критерия, например от типа памяти, с которой производится взаимодействие, таким образом, целью является

* энергозависимая память;
* энергонезависимая память.

Данная работа посвящена изучению и разработке методов первой группы. При этом получение дампа возможно с помощью

* программного обеспечения
* использования аппаратных средств.

Методы в той или иной степени могут удовлетворять требованиям криминалистического подхода к целостности и предотвращния «загрязнения» данных. По данному критерию можно выделить следующие группы методов:

* криминалистически правильные;
* криминалистически сомнительные;
* криминалистически неправильные.

Криминалистически правильные – методы, полностью удовлетворяющие требованиям криминалистического подхода. Применение криминалистически сомнительных методов не оказывает влияния на данные, однако не гарантирует сохранения целостности, т. е. получение данных не является атомарной операцией. Последняя группа подразумевает методы, непосредственно изменяющих данные, что нарушает их целостность и/или достоверность. В дальнейшем будем рассматривать только два последних класса методов.

Большая часть подходов к получению дампов памяти подразумевают использование дополнительно установленного программного обеспечения непосредственно на стороне целевой системы. Такие методы будем называть инвазивными. Соответственно выделим два класса по данному критерию:

* инвазивные;
* неинвазивные.

Необходимо также рассматривать возможность непрерывной работы целевой системы при ее исследовании, в частности, получения дампа оперативной памяти. В этом случае методы разделяют на:

* требующие остановки системы;
* не требующие остановки системы.

Примером неинвазивного, криминалистически правильного метода, требующего остановки системы является стандартная функция гипервизора QEMU/KVM pmemsave. При этом виртуальная машина приостанавливается гипервизором, после чего снимается дамп оперативной памяти. Подробнее о различных методах будет обсуждено далее.

### Актуальность работы

В случае облачных технологий, основанных на применении платформ виртуализации, наиболее эффективным является подход к противодействию несанкционированной активности внутри целевых систем, основанный на механизме интроспекции виртуальных машин для мониторинга и анализа операционных систем извне (со стороны гипервизора). Основное преимущество здесь заключается в отсутствии доступа вредоносного ПО из гостевых машин к памяти хоста и, параллельно, полном доступе к "физической" памяти виртуальных машин для резидентов хост-системы. В этом случае мы говорим о возможности: 

1. неинвазивного (т.е. без внедрения в гостевую память) изучения динамики оперативной памяти целевых систем; 
2. создания проактивной (упреждающей) защиты целевых машин на основе высокочастотного мониторинга на предмет появления гарантированно опасных или аномальных активностей в памяти.

### Цель работы

Данная работа посвящена изучению и разработке методов извлечения дампов оперативной памяти виртуальных машин. Необходимо учитывать определенные требования к разрабатываемому инструменту:

* изолированность инструментов от памяти исследуемой машины. Соблюдение данного условия обеспечивает целостность и корректность полученных данных;
* достоверность результата. Инструмент должен учитывать возможное воздействие вредоносных программ на любые функциональные уровни целевой машины;
* быстродействие. Мониторинг должен осуществляться в реальном времени.

### Задачи работы

Цель работы предполагает решения ряда соответствующих задач:

1. изучение методов получения дампов оперативной памяти;
2. выбор наиболее подходящего метода, обоснованность выбора;
3. разработка соответствующего программного комплекса для извлечения дампа памяти;
4. проведение эксперимента для верификации разработанного программного обеспечения.

## Глава 1

### Монитор виртуальных машин

На сегодняшний день существует множество различных гипервизоров и эмуляторов. Среди них большой популярностью пользуется QEMU (Quick Emulator), как одно из наиболее универсальных средств. Такие продукты, как VirtualBox, Xen имеют базовые составляющие QEMU [3]. В рамках данной работы важным преимуществом также является открытый исходный код эмулятора, а также поддерживаемость библиотекой libvirt, унифицирующий использование функционала различных мониторов виртуальных машин. В настоящее время QEMU используется совместно с модулем KVM (Kernel-based Virtual Machine), что обеспечивает высокую производительность. Говоря о QEMU/KVM, будем иметь ввиду именно совокупность данных инструментов. Для реализации методов необходимо иметь представления о реализации данной платформы.

### Устройство QEMU/KVM

>Как у Василия, что-то надо придумать

## Глава 2

### Существующие методы

Кратко разберем некоторые существующие методы получения дампов и подробнее рассмотрим те из них, которые представляют наибольший интерес.

*Tribble* - PCI карта расширения (PCI expansion card), которая может использоваться для получения содержимого физической памяти. Данный метод имеет свои сильные стороны и ограничения. Как аппаратное средство, Tribble может получать доступ к памяти без установки дополнительного программного обеспечения. Однако данное утройство не получило распространения из-за необходимости предварительной установки, что является серьезным недостатком для криминалистических исследований. 

Другим решением с использованием аппаратных средств являются устройства *Firewire*, которые используют прямой доступ к памяти (Direct Memory Access, DMA), в обход центрального процессора. Мэппинг памяти (memory mapping) производится в аппартной среде, в обход операционной системы, что обеспечивает высокоскоростное копирование. Проблема данного метода лежит в вопросе с UMA (Upper Memory Area), что иногда вызывает сбой системы.

Такие подходы, являются неинвазивным и не требующим остановки системы, однако целостность данных не сохраняется, поскольку целевая система не останавливается и данные изменяются, иными словами метод криминалистически сомнительный. Приоритетом в рамках поставленной задачи пользуется все же программное обеспечение, поскольку с помощью него можно достигнуть схожих результатов без необходимости приобретения устройств копирования.

Аварийные дампы Microsoft. Несмотря на то, что данный метод неинвазивный и криминалистически правильный, у него мало преимуществ перед другими подходами, так как необходимо изменять настройки системы, а в общем случае перезагрузить систему для приведения настроек в действие. Помимо этого, система не просто приостанавливается, но полностью завершает работу.

Belkasoft Live RAM Caputer – инструмент, который может получать дампы оперативной памяти, запускаясь при этом с USB-флеш-накопителя. Данный метод можно классифицировать как инвазивный, криманилистически сомнительный, не требующий остановки целевой системы. Инвазивность заключается в выполнении кода программы в оперативной памяти, то же является и причиной криминалистической сомнительности. То же можно сказать о продуктах действующих по похожему принципу, таких как MANDIANT Memoryze, HBGary, FTK Imager.

Целью данной работы является получение дампов памяти виртуальных машин, что делает выбор соответствующих методов более широким. Из описания работы гипервизора QEMU/KVM в **первой главе ** можно сделать вывод, что оперативная память виртуальной машины, в сущности, является выделенным блоком памяти хоста, который располагается внутри процесса, поэтому можно применять методы, получающие лишь часть оперативной памяти, выделенной для процесса.

Чтение памяти, выделенной процессу. /proc/$pid/mem показывает содержимое отображения памяти $pid таким же образом, как в процессе, т. е. байт на позиции *x* в псевдо-файле тот же, что и байт на позиции *x* в процессе. Если память освобождается по определенному адресу, чтение из соответствующего файла приведет к ошибке EIO (Input/output error). Например, поскольку первая страница процесса никогда не отображается, чтение первого байта /proc/$pid/mem всегда вызывает ошибку EIO. Чтобы найти корректные части памяти процесса достаточно прочитать /proc/$pid/maps. Данный файл содержит по одной линии на соответствующий регион памяти, что выглядит следующим образом:
```
08048000-08054000 r-xp 00000000 08:01 828061     /bin/cat
08c9b000-08cbc000 rw-p 00000000 00:00 0          [heap]
```
Первые два числа являются границами региона (адреса первого байта и байта, следующего за последним, в шестнадцатиричном формате). Далее указаны права доступа, после содержится некоторая информация о файле, если это отображение файла. 

Попытка чтения /proc/$pid/mem из другого процесса обычным способом приводит к ошибке ESRCH (Процесс не существует). Указанные права доступа для /proc/$pid/mem показывают больший доступ, чем, по существу, есть на самом деле. Кроме того, попытка чтения памяти процесса в то время, пока процесс ее изменяет, может дать некорректный вид памяти. Таким образом необходимо производить дополнительные операции:

* процесс, желающий читать /proc/$pid/mem должен присоединиться к соответствующему процессу с помощью функции ptrace() с флагом PTRACE_ATTACH. Данную процедуру выполняют отладчики при отладке процесса. По окончании чтения из /proc/$pid/mem, процесс должен вызвать функцию ptrace() с флагом PTRACE_DETACH для прерывания соединения.
* процесс, чья память считывается не должен выполняться в момент считывания. Обычно, вызов функции ptrace(PTRACE_ATTACH, ...) останавливает целевой процесс (посылает сигнал STOP), но из-за состояния гонки (доставка сигнала асинхронна), поэтому вызывающий процесс должен использовать функцию wait().

Метод, использующий описанный алгоритм, имплементирован в GDB (GNU Debugger) и может быть применен простым скриптом:
```
#!/bin/bash

grep rw-p /proc/$1/maps | \
sed -n 's/^\([0-9a-f]*\)-\([0-9a-f]*\) .*$/\1 \2/p' | \
while read start stop; \
do gdb --batch --pid $1 -ex "dump memory $1-$start-$stop.dump 0x$start 0x$stop"; \
done

```
Такой подход является неинвазивным и криминалистически правильным, однако требует остановки процесса, что, в свою очередь, означает остановку целевой системы. 

Для улучшения данного метода возможным является дополнительное использование функции fork(), с целью создания копии адресного пространства процесса с механизмом копирования при записи (COW, Copy-On-Write). Однако использование функции fork() применительно к многопоточному процессу не является корректным, поскольку копируется единственный поток, из которого применялся вызов функции. Идея все же была осуществлена в инструменте google-coredumper, целью которого является получение дампа памяти многопоточного процесса, читаемого с помощью GDB. Функции данной библиотеки моментально останавливают все потоки, создавая копию адресного пространства процесса с механизмом копирования при записи. К сожалению, из-за сложностей реализации инструмент не оказался достаточно универсальным, с выходом новых версий ядра Линукса (Linux) google-coredumper перестал корректно работать. Несмотря на это, концепция метода является привлекательной, поскольку такой подход одновременно является криминалистически правильным, не требующим остановки процесса, неинвазивным и, ко всему прочему, потенциально имеет различные применения в решении ряда других задач.

Использование средств гипервизора для создания дампов оперативной памяти. Мониторы виртуальных машин среди стандартных функции, как правило, имеют функции сохранения состояния виртуальной машины и создания дампов оперативной памяти гостевой системы. В качестве примера можно рассмотреть команду pmemsave гипервизора QEMU/KVM. Данная команда вызывает соответствующую функцию qmp_pmemsave(), Работы данной функции кратко можно описать последовательностью основных действий, похожую на алгоритм чтения памяти из другого процесса. Сначала производится поиск соответствующего блока памяти процесса, откуда необходимо произвести чтение, что сопровождается трансляцией адреса виртуального адресного пространства в физический адрес и установки блокировки блока памяти на чтение, что необходимо для сохранения целостности данных, при этом, фактически, виртуальная машина полностью останавливается. Далее непосредственно производится чтение из блока памяти в буфер, снимается блокировка с соответсвующего блока, и данные из буфера переписываются в файл на жестком диске. Вся процедура происходит циклически, пока не будет переписана вся оперативная память виртуальной машины.

Практически все методы получения дампа оперативной памяти с помощью гипервизора сводятся к набору вышеперечисленных операций, среди которых важной является блокировка читаемой памяти, что обеспечивает целостность считываемх данных. Это обуславливается тем, что основной целью таких функций является либо сохранение состояния виртуальной машины для последующего восстановления, либо для анализа содержимого ее оперативной памяти. Такие методы можно объединить в одну группу криминалистически правильных, неинвазивных, требующих остановки целевой системы. Кроме того, стоит заметить, что использование конкретных функций одного гипервизора является далеко не лучшим решением по критерию универсальности, поэтому следует рассмотреть более универсальные библиотеки, такие как libvirt.

## Список литературы

1. Thu Yein Win, Huaglory Tianfield, Quentin Mair. Virtualization Security Combining Mandatory Access Control and Virtual Machine Introspection. UCC '14: Proceedings of the 2014 IEEE/ACM 7th International Conference on Utility and Cloud Computing. December 2014. 1004 p.
2. Федотов Н.Н. Форензика – компьютерная криминалистика. Москва: «Юридический мир», 2007. 360 с.

3. http://qemu.weilnetz.de/qemu-tech.html#QEMU-Internals

4. Naja Davis. Live Memory Acquisition for Windows Operating Systems:  Cover Page and Abstract Tools and Techniques for Analysis. Eastern Michigan University. 4 – 6 p.
